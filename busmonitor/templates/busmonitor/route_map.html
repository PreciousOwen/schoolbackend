{% extends 'base.html' %}
{% block content %}
<h2 style="color:var(--primary);margin-bottom:30px;text-align:center;">Route Map: {{ route.name }}</h2>

<p style="text-align:center;">
  From: {{ route.start_location }}<br>
  To: {{ route.end_location }}
</p>

<div id="map"
     style="height:420px;width:100%;min-width:320px;min-height:320px;max-width:700px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.10);margin-left:auto;margin-right:auto"
     data-start="{{ route.start_location|escapejs }}"
     data-end="{{ route.end_location|escapejs }}">
</div>

<div id="map-loading" style="text-align:center;margin-top:10px;">
  <span>Loading map...</span>
</div>

<div id="map-error" style="display:none;color:var(--danger);text-align:center;margin-top:10px;"></div>

<div style="text-align:right;margin-top:8px;">
  <a href="https://schoolroute.silicon4forge.org/" target="_blank" style="color:var(--primary);font-weight:500;text-decoration:underline;">View Full Map</a>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPqc3uljT9n77v0uTQikuRor5tSfSV0RI"></script>
<script>
(function() {
  let map, directionsService, directionsRenderer;

  function showError(msg) {
    const errDiv = document.getElementById('map-error');
    errDiv.textContent = msg;
    errDiv.style.display = 'block';
  }
  function hideError() {
    const errDiv = document.getElementById('map-error');
    errDiv.style.display = 'none';
  }

  function initMap() {
    const mapDiv = document.getElementById('map');
    const start = mapDiv.getAttribute('data-start');
    const end = mapDiv.getAttribute('data-end');

    map = new google.maps.Map(mapDiv, {
      zoom: 7,
      center: { lat: 0, lng: 0 },
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      map: map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: "#007bff",
        strokeWeight: 5
      }
    });

    directionsService.route(
      {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        document.getElementById('map-loading').style.display = 'none';
        if (status === 'OK') {
          hideError();
          directionsRenderer.setDirections(result);
        } else {
          showError('Failed to load route. Please try again later.');
          console.error('Directions request failed due to ' + status);
        }
      }
    );
  }

  window.addEventListener('DOMContentLoaded', initMap);
})();
</script>
{% endblock %}
